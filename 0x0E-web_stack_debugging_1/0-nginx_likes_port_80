#!/usr/bin/env bash
# This script ensures Nginx listens on port 80, resolving conflicts and checking for errors.

# 1. Stop conflicting processes on port 80
conflicting_pids=$(lsof -i :80 -t)
if [ -n "$conflicting_pids" ]; then
    echo "Other processes using port 80 (PIDs: $conflicting_pids). Stopping..."
    kill $conflicting_pids  # Assuming you have permission to stop them
fi

# 2. Update Nginx config to listen on port 80
sed -i 's/listen\s*[^;]*;/listen 80;/' /etc/nginx/sites-enabled/* 

# 3. Check Nginx configuration for errors
if ! nginx -t; then
    echo "Error: Nginx configuration test failed. Fix configuration errors and try again."
    exit 1
fi

# 4. Restart Nginx service
systemctl restart nginx

# 5. Verify Nginx is listening on port 80
if ss -tulpn | grep -q ":80 "; then 
    echo "Nginx is successfully listening on port 80."
else
    echo "Error: Nginx failed to listen on port 80. Check the logs for details."
    exit 1
fi
